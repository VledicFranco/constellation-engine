openapi: 3.0.3
info:
  title: Constellation Engine API
  version: 1.0.0
  description: |
    REST API for the Constellation Engine - a type-safe, composable ML orchestration framework.

    This API allows you to:
    - Compile constellation-lang source code into executable pipelines
    - Execute compiled pipelines with input data
    - Compile and run scripts in a single request
    - Query available modules and namespaces
    - Manage pipeline versions, hot-reload, and canary deployments
    - Manage suspended executions

    ## Quick Start

    1. Compile a script: `POST /compile`
    2. Execute it: `POST /execute`

    Or use the combined endpoint: `POST /run`

    ## WebSocket

    For IDE integration via Language Server Protocol (LSP), connect to `ws://host:port/lsp`.
    See the LSP documentation for message formats.
  contact:
    name: Constellation Engine
    url: https://github.com/VledicFranco/constellation-engine
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8080
    description: Local development server

tags:
  - name: Compilation
    description: Compile constellation-lang source code
  - name: Execution
    description: Execute compiled DAGs
  - name: Pipelines
    description: Manage stored pipelines (content-addressed)
  - name: Canary
    description: Canary deployment management for pipelines
  - name: Executions
    description: Manage suspended and completed executions
  - name: Modules
    description: Query available modules
  - name: Namespaces
    description: Query function namespaces
  - name: Health
    description: Server health and readiness checks
  - name: Metrics
    description: Server metrics and statistics

paths:
  /compile:
    post:
      tags:
        - Compilation
      summary: Compile constellation-lang source code
      description: |
        Compiles constellation-lang source code and stores the resulting DAG
        with the specified name. The DAG can then be executed via `/execute`.
      operationId: compile
      security:
        - bearerAuth: []
        - {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CompileRequest'
            example:
              source: |
                in text: String
                result = Uppercase(text)
                out result
              dagName: "my-pipeline"
      responses:
        '200':
          description: Compilation successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CompileResponse'
              example:
                success: true
                dagName: "my-pipeline"
                errors: []
        '400':
          description: Compilation errors
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CompileResponse'
              example:
                success: false
                dagName: null
                errors:
                  - "Undefined function: Upppercase"
                  - "Type mismatch: expected String, got Int"
        '413':
          description: Request body too large (max 10MB)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: Rate limit exceeded
          headers:
            Retry-After:
              schema:
                type: integer
              description: Seconds to wait before retrying
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /execute:
    post:
      tags:
        - Execution
      summary: Execute a stored DAG
      description: |
        Executes a previously compiled DAG with the provided inputs.
        The DAG must have been stored via `/compile` first.
      operationId: execute
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExecuteRequest'
            example:
              dagName: "my-pipeline"
              inputs:
                text: "hello world"
      responses:
        '200':
          description: Execution successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExecuteResponse'
              example:
                success: true
                outputs:
                  result: "HELLO WORLD"
                error: null
        '400':
          description: Input validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExecuteResponse'
              example:
                success: false
                outputs: {}
                error: "Input error: Missing required input 'text'"
        '404':
          description: Pipeline not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "NotFound"
                message: "Pipeline 'unknown-pipeline' not found"
        '500':
          description: Execution error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExecuteResponse'
              example:
                success: false
                outputs: {}
                error: "Execution failed: Module 'ExternalAPI' threw exception"

  /run:
    post:
      tags:
        - Compilation
        - Execution
      summary: Compile and run a script in one step
      description: |
        Compiles constellation-lang source code and executes it immediately
        without storing the DAG. Useful for one-off executions and testing.
      operationId: run
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RunRequest'
            example:
              source: |
                in name: String
                in count: Int
                greeting = Concat("Hello, ", name)
                repeated = Repeat(greeting, count)
                out repeated
              inputs:
                name: "World"
                count: 3
      responses:
        '200':
          description: Compilation and execution successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunResponse'
              example:
                success: true
                outputs:
                  repeated: "Hello, World Hello, World Hello, World"
                compilationErrors: []
                error: null
        '400':
          description: Compilation or input error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunResponse'
              example:
                success: false
                outputs: {}
                compilationErrors:
                  - "Undefined function: Repeatt"
                error: null
        '500':
          description: Execution error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunResponse'
              example:
                success: false
                outputs: {}
                compilationErrors: []
                error: "Execution failed: Division by zero"

  /modules:
    get:
      tags:
        - Modules
      summary: List all available modules
      description: |
        Returns a list of all registered modules that can be used in
        constellation-lang scripts. Includes module signatures and descriptions.
      operationId: listModules
      responses:
        '200':
          description: List of modules
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModuleListResponse'
              example:
                modules:
                  - name: "Uppercase"
                    description: "Converts text to uppercase"
                    version: "1.0"
                    inputs:
                      text: "CString"
                    outputs:
                      result: "CString"
                  - name: "WordCount"
                    description: "Counts words in text"
                    version: "1.0"
                    inputs:
                      text: "CString"
                    outputs:
                      count: "CInt"

  /namespaces:
    get:
      tags:
        - Namespaces
      summary: List all available namespaces
      description: |
        Returns a list of all function namespaces available for import
        in constellation-lang scripts using `use` statements.
      operationId: listNamespaces
      responses:
        '200':
          description: List of namespaces
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NamespaceListResponse'
              example:
                namespaces:
                  - "stdlib"
                  - "stdlib.math"
                  - "stdlib.string"
                  - "stdlib.boolean"

  /namespaces/{namespace}:
    get:
      tags:
        - Namespaces
      summary: List functions in a namespace
      description: |
        Returns all functions available in a specific namespace.
        Includes function signatures and parameter types.
      operationId: getNamespaceFunctions
      parameters:
        - name: namespace
          in: path
          required: true
          description: Namespace name
          schema:
            type: string
          example: "stdlib.math"
      responses:
        '200':
          description: Namespace functions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NamespaceFunctionsResponse'
              example:
                namespace: "stdlib.math"
                functions:
                  - name: "Add"
                    qualifiedName: "stdlib.math.Add"
                    params:
                      - "a: Int"
                      - "b: Int"
                    returns: "Int"
                  - name: "Multiply"
                    qualifiedName: "stdlib.math.Multiply"
                    params:
                      - "a: Int"
                      - "b: Int"
                    returns: "Int"
        '404':
          description: Namespace not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "NamespaceNotFound"
                message: "Namespace 'stdlib.unknown' not found or has no functions"

  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Returns server health status. Basic health endpoint for simple checks.
      operationId: healthCheck
      responses:
        '200':
          description: Server is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [ok]
              example:
                status: "ok"

  /health/live:
    get:
      tags:
        - Health
      summary: Liveness probe
      description: |
        Returns 200 if the process is alive. Always succeeds when the server is running.
        Use for Kubernetes liveness probes.
      operationId: healthLive
      responses:
        '200':
          description: Process is alive
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthLiveResponse'
              example:
                status: "alive"

  /health/ready:
    get:
      tags:
        - Health
      summary: Readiness probe
      description: |
        Returns 200 if the system is ready to serve traffic, 503 otherwise.
        Checks lifecycle state (must be Running) and any custom readiness checks.
        Use for Kubernetes readiness probes.
      operationId: healthReady
      responses:
        '200':
          description: System is ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthReadyResponse'
              example:
                ready: true
        '503':
          description: System is not ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthReadyResponse'
              example:
                ready: false
                reason: "System is draining"

  /health/detail:
    get:
      tags:
        - Health
      summary: Detailed health diagnostics
      description: |
        Returns component-level diagnostics including scheduler stats, lifecycle state,
        and custom check results. This endpoint is **opt-in** — it must be explicitly
        enabled via `HealthCheckConfig(enableDetailEndpoint = true)`.

        When `detailRequiresAuth` is true (default), this endpoint requires
        authentication via Bearer token.
      operationId: healthDetail
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Detailed health information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthDetailResponse'
              example:
                status: "healthy"
                lifecycle: "Running"
                scheduler:
                  activeCount: 3
                  queuedCount: 0
                  totalSubmitted: 1500
                  totalCompleted: 1497
                checks:
                  compiler: true
                  scheduler: true
        '401':
          description: Missing or invalid authentication
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Unauthorized"
                message: "Missing or invalid Authorization header"
        '403':
          description: Insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Forbidden"
                message: "Insufficient permissions"
        '404':
          description: Detail endpoint not enabled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "NotFound"
                message: "Detail endpoint is not enabled"

  /pipelines:
    get:
      tags:
        - Pipelines
      summary: List all stored pipelines
      description: |
        Returns all pipelines stored in the PipelineStore, including their
        structural hash, syntactic hash, name, and metadata.
      operationId: listPipelines
      responses:
        '200':
          description: List of stored pipelines
          content:
            application/json:
              schema:
                type: object
                properties:
                  pipelines:
                    type: array
                    items:
                      type: object
                      properties:
                        name:
                          type: string
                        structuralHash:
                          type: string
                        syntacticHash:
                          type: string

  /pipelines/{ref}:
    get:
      tags:
        - Pipelines
      summary: Get a pipeline by reference
      description: |
        Retrieve a stored pipeline by name, structural hash, or syntactic hash.
        Returns pipeline details including modules, inputs, and outputs.
      operationId: getPipeline
      parameters:
        - name: ref
          in: path
          required: true
          description: Pipeline reference (name, structural hash, or syntactic hash)
          schema:
            type: string
      responses:
        '200':
          description: Pipeline found
          content:
            application/json:
              schema:
                type: object
        '404':
          description: Pipeline not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      tags:
        - Pipelines
      summary: Delete a pipeline
      description: Remove a stored pipeline by reference.
      operationId: deletePipeline
      security:
        - bearerAuth: []
      parameters:
        - name: ref
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Pipeline deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  deleted:
                    type: boolean
                  ref:
                    type: string
        '404':
          description: Pipeline not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /pipelines/{name}/alias:
    put:
      tags:
        - Pipelines
      summary: Repoint a pipeline alias
      description: |
        Update a named pipeline alias to point to a different structural hash.
        Allows blue-green deployments by atomically switching which version a name resolves to.
      operationId: updatePipelineAlias
      security:
        - bearerAuth: []
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - structuralHash
              properties:
                structuralHash:
                  type: string
                  description: Target structural hash to alias to
      responses:
        '200':
          description: Alias updated
        '404':
          description: Target hash not found

  /pipelines/{name}/reload:
    post:
      tags:
        - Pipelines
      summary: Hot-reload a pipeline
      description: |
        Recompile and reload a pipeline from its stored source or new source.
        Optionally starts a canary deployment for safe rollout.
      operationId: reloadPipeline
      security:
        - bearerAuth: []
      parameters:
        - name: name
          in: path
          required: true
          description: Pipeline name
          schema:
            type: string
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReloadRequest'
      responses:
        '200':
          description: Pipeline reloaded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReloadResponse'
        '400':
          description: Compilation error in new source
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Pipeline not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /pipelines/{name}/versions:
    get:
      tags:
        - Pipelines
      summary: List pipeline version history
      description: |
        Returns the version history for a named pipeline, including structural
        hashes, timestamps, and which version is currently active.
      operationId: listPipelineVersions
      parameters:
        - name: name
          in: path
          required: true
          description: Pipeline name
          schema:
            type: string
      responses:
        '200':
          description: Version history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PipelineVersionsResponse'
        '404':
          description: Pipeline not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /pipelines/{name}/rollback:
    post:
      tags:
        - Pipelines
      summary: Rollback to previous pipeline version
      description: |
        Rolls back a pipeline to its immediately previous version.
      operationId: rollbackPipeline
      security:
        - bearerAuth: []
      parameters:
        - name: name
          in: path
          required: true
          description: Pipeline name
          schema:
            type: string
      responses:
        '200':
          description: Rollback successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RollbackResponse'
        '404':
          description: Pipeline not found or no previous version
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /pipelines/{name}/rollback/{version}:
    post:
      tags:
        - Pipelines
      summary: Rollback to a specific pipeline version
      description: |
        Rolls back a pipeline to a specific version number from its history.
      operationId: rollbackPipelineToVersion
      security:
        - bearerAuth: []
      parameters:
        - name: name
          in: path
          required: true
          description: Pipeline name
          schema:
            type: string
        - name: version
          in: path
          required: true
          description: Version number to rollback to
          schema:
            type: integer
      responses:
        '200':
          description: Rollback successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RollbackResponse'
        '404':
          description: Pipeline or version not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /pipelines/{name}/canary:
    get:
      tags:
        - Canary
      summary: Get canary deployment status
      description: |
        Returns the current canary deployment state for a pipeline,
        including traffic weight, metrics, and promotion step.
      operationId: getCanaryStatus
      parameters:
        - name: name
          in: path
          required: true
          description: Pipeline name
          schema:
            type: string
      responses:
        '200':
          description: Canary state
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CanaryStateResponse'
        '404':
          description: No active canary for this pipeline
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      tags:
        - Canary
      summary: Abort canary deployment
      description: |
        Aborts the canary deployment, reverting all traffic to the old version.
      operationId: abortCanary
      security:
        - bearerAuth: []
      parameters:
        - name: name
          in: path
          required: true
          description: Pipeline name
          schema:
            type: string
      responses:
        '200':
          description: Canary aborted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CanaryStateResponse'
        '404':
          description: No active canary for this pipeline
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /pipelines/{name}/canary/promote:
    post:
      tags:
        - Canary
      summary: Promote canary deployment
      description: |
        Manually promotes the canary to the next step (or to full traffic).
        Advances the traffic weight according to the configured promotion steps.
      operationId: promoteCanary
      security:
        - bearerAuth: []
      parameters:
        - name: name
          in: path
          required: true
          description: Pipeline name
          schema:
            type: string
      responses:
        '200':
          description: Canary promoted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CanaryStateResponse'
        '404':
          description: No active canary for this pipeline
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /pipelines/{name}/canary/rollback:
    post:
      tags:
        - Canary
      summary: Rollback canary deployment
      description: |
        Rolls back the canary deployment, reverting all traffic to the old version
        and marking the canary as rolled back.
      operationId: rollbackCanary
      security:
        - bearerAuth: []
      parameters:
        - name: name
          in: path
          required: true
          description: Pipeline name
          schema:
            type: string
      responses:
        '200':
          description: Canary rolled back
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CanaryStateResponse'
        '404':
          description: No active canary for this pipeline
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /executions:
    get:
      tags:
        - Executions
      summary: List suspended executions
      description: |
        Returns a list of suspended executions that are waiting for additional
        inputs or external resolution before they can continue.
      operationId: listExecutions
      responses:
        '200':
          description: List of suspended executions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExecutionListResponse'

  /executions/{id}:
    get:
      tags:
        - Executions
      summary: Get execution detail
      description: |
        Returns the details of a specific execution, including its status,
        missing inputs, and resumption count.
      operationId: getExecution
      parameters:
        - name: id
          in: path
          required: true
          description: Execution ID (UUID)
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Execution details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExecutionSummary'
        '404':
          description: Execution not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      tags:
        - Executions
      summary: Delete a suspended execution
      description: |
        Removes a suspended execution from the store. This cannot be undone.
      operationId: deleteExecution
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: Execution ID (UUID)
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Execution deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  deleted:
                    type: boolean
                  executionId:
                    type: string
        '404':
          description: Execution not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /executions/{id}/resume:
    post:
      tags:
        - Executions
      summary: Resume a suspended execution
      description: |
        Resumes a suspended execution by providing additional inputs or
        resolved node values. The execution will continue from where it
        was suspended.
      operationId: resumeExecution
      parameters:
        - name: id
          in: path
          required: true
          description: Execution ID (UUID)
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ResumeRequest'
      responses:
        '200':
          description: Execution resumed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExecuteResponse'
        '400':
          description: Invalid resume request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Execution not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /metrics:
    get:
      tags:
        - Metrics
      summary: Server metrics
      description: |
        Returns server statistics including uptime, request count,
        compilation cache metrics, and scheduler statistics.

        Supports content negotiation:
        - `Accept: application/json` (default) — JSON format
        - `Accept: text/plain` — Prometheus exposition text format
      operationId: getMetrics
      responses:
        '200':
          description: Current server metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MetricsResponse'
              example:
                timestamp: "2026-01-15T10:30:00Z"
                server:
                  uptime_seconds: 3600
                  requests_total: 15000
                cache:
                  hits: 12000
                  misses: 3000
                  hitRate: 0.8
                  evictions: 50
                  entries: 200
                scheduler:
                  enabled: true
                  activeCount: 3
                  queuedCount: 0
                  totalSubmitted: 15000
                  totalCompleted: 14997
            text/plain:
              schema:
                type: string
              example: |
                # HELP constellation_server_uptime_seconds Server uptime in seconds.
                # TYPE constellation_server_uptime_seconds gauge
                constellation_server_uptime_seconds 3600
                # HELP constellation_server_requests_total Total HTTP requests served.
                # TYPE constellation_server_requests_total counter
                constellation_server_requests_total 15000

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      description: |
        API key authentication. Pass the API key as a Bearer token in the
        Authorization header: `Authorization: Bearer <api-key>`.

        Roles: Admin (all methods), Execute (GET + POST), ReadOnly (GET only).

        Public paths exempt from auth: `/health`, `/health/live`, `/health/ready`, `/metrics`.

  schemas:
    CompileRequest:
      type: object
      required:
        - source
        - dagName
      properties:
        source:
          type: string
          description: Constellation-lang source code
          example: |
            in text: String
            result = Uppercase(text)
            out result
        dagName:
          type: string
          description: Name to assign to the compiled DAG
          example: "my-pipeline"

    CompileResponse:
      type: object
      required:
        - success
      properties:
        success:
          type: boolean
          description: Whether compilation succeeded
        dagName:
          type: string
          nullable: true
          description: Name of the compiled DAG (if successful)
        errors:
          type: array
          items:
            type: string
          description: List of compilation error messages
          default: []

    ExecuteRequest:
      type: object
      required:
        - dagName
        - inputs
      properties:
        dagName:
          type: string
          description: Name of the DAG to execute
        inputs:
          type: object
          additionalProperties: true
          description: Input values as JSON (keys must match DAG input declarations)

    ExecuteResponse:
      type: object
      required:
        - success
      properties:
        success:
          type: boolean
          description: Whether execution succeeded
        outputs:
          type: object
          additionalProperties: true
          description: Output values as JSON
          default: {}
        error:
          type: string
          nullable: true
          description: Error message if execution failed
        status:
          type: string
          nullable: true
          description: Execution status (completed, suspended)
        executionId:
          type: string
          nullable: true
          description: Execution ID for suspended executions
        missingInputs:
          type: object
          nullable: true
          additionalProperties:
            type: string
          description: Missing input names and their expected types
        pendingOutputs:
          type: array
          nullable: true
          items:
            type: string
          description: Outputs not yet computed
        resumptionCount:
          type: integer
          nullable: true
          description: Number of times this execution has been resumed

    RunRequest:
      type: object
      required:
        - source
        - inputs
      properties:
        source:
          type: string
          description: Constellation-lang source code
        inputs:
          type: object
          additionalProperties: true
          description: Input values as JSON

    RunResponse:
      type: object
      required:
        - success
      properties:
        success:
          type: boolean
          description: Whether compilation and execution succeeded
        outputs:
          type: object
          additionalProperties: true
          description: Output values as JSON
          default: {}
        compilationErrors:
          type: array
          items:
            type: string
          description: List of compilation error messages
          default: []
        error:
          type: string
          nullable: true
          description: Runtime error message if execution failed

    ReloadRequest:
      type: object
      properties:
        source:
          type: string
          nullable: true
          description: New source code to compile. If omitted, recompiles from stored source.
        canary:
          $ref: '#/components/schemas/CanaryConfig'

    ReloadResponse:
      type: object
      required:
        - success
        - newHash
        - name
        - changed
        - version
      properties:
        success:
          type: boolean
          description: Whether reload succeeded
        previousHash:
          type: string
          nullable: true
          description: Structural hash of the previous version
        newHash:
          type: string
          description: Structural hash of the new version
        name:
          type: string
          description: Pipeline name
        changed:
          type: boolean
          description: Whether the pipeline actually changed (structural hash differs)
        version:
          type: integer
          description: New version number
        canary:
          $ref: '#/components/schemas/CanaryStateResponse'

    CanaryConfig:
      type: object
      properties:
        initialWeight:
          type: number
          format: double
          description: Initial traffic weight for the new version (0.0-1.0)
          default: 0.05
        promotionSteps:
          type: array
          items:
            type: number
            format: double
          description: Traffic weight progression steps
          default: [0.10, 0.25, 0.50, 1.0]
        observationWindow:
          type: string
          description: Duration to observe each step (e.g., "5m", "1h")
          default: "5m"
        errorThreshold:
          type: number
          format: double
          description: Maximum error rate before auto-rollback (0.0-1.0)
          default: 0.05
        latencyThresholdMs:
          type: integer
          format: int64
          nullable: true
          description: Maximum p99 latency in ms before auto-rollback
        minRequests:
          type: integer
          description: Minimum requests before evaluating metrics
          default: 10
        autoPromote:
          type: boolean
          description: Whether to auto-promote when metrics are healthy
          default: true

    PipelineVersionInfo:
      type: object
      required:
        - version
        - structuralHash
        - createdAt
        - active
      properties:
        version:
          type: integer
          description: Version number
        structuralHash:
          type: string
          description: Structural hash of this version
        createdAt:
          type: string
          format: date-time
          description: When this version was created
        active:
          type: boolean
          description: Whether this version is currently active

    PipelineVersionsResponse:
      type: object
      required:
        - name
        - versions
      properties:
        name:
          type: string
          description: Pipeline name
        versions:
          type: array
          items:
            $ref: '#/components/schemas/PipelineVersionInfo'

    RollbackResponse:
      type: object
      required:
        - success
        - name
        - version
        - structuralHash
      properties:
        success:
          type: boolean
          description: Whether rollback succeeded
        name:
          type: string
          description: Pipeline name
        version:
          type: integer
          description: Version rolled back to
        structuralHash:
          type: string
          description: Structural hash of the rolled-back version

    CanaryStateResponse:
      type: object
      required:
        - pipelineName
        - oldVersion
        - newVersion
        - currentWeight
        - currentStep
        - status
        - startedAt
        - metrics
      properties:
        pipelineName:
          type: string
          description: Pipeline name
        oldVersion:
          $ref: '#/components/schemas/CanaryVersionInfo'
        newVersion:
          $ref: '#/components/schemas/CanaryVersionInfo'
        currentWeight:
          type: number
          format: double
          description: Current traffic weight to new version (0.0-1.0)
        currentStep:
          type: integer
          description: Current promotion step index
        status:
          type: string
          description: Canary status
          enum: [Observing, Promoting, RolledBack, Complete]
        startedAt:
          type: string
          format: date-time
          description: When the canary deployment started
        metrics:
          $ref: '#/components/schemas/CanaryMetricsResponse'

    CanaryVersionInfo:
      type: object
      required:
        - version
        - structuralHash
      properties:
        version:
          type: integer
          description: Version number
        structuralHash:
          type: string
          description: Structural hash

    CanaryMetricsResponse:
      type: object
      properties:
        oldVersion:
          type: object
          properties:
            requests:
              type: integer
              format: int64
            errorRate:
              type: number
              format: double
            avgLatencyMs:
              type: number
              format: double
        newVersion:
          type: object
          properties:
            requests:
              type: integer
              format: int64
            errorRate:
              type: number
              format: double
            avgLatencyMs:
              type: number
              format: double

    ExecutionSummary:
      type: object
      required:
        - executionId
        - structuralHash
        - resumptionCount
        - missingInputs
        - createdAt
      properties:
        executionId:
          type: string
          description: Execution ID (UUID)
        structuralHash:
          type: string
          description: Structural hash of the pipeline
        resumptionCount:
          type: integer
          description: Number of times this execution has been resumed
        missingInputs:
          type: object
          additionalProperties:
            type: string
          description: Missing input names and their expected types
        createdAt:
          type: string
          format: date-time
          description: When the execution was created

    ExecutionListResponse:
      type: object
      required:
        - executions
      properties:
        executions:
          type: array
          items:
            $ref: '#/components/schemas/ExecutionSummary'

    ResumeRequest:
      type: object
      properties:
        additionalInputs:
          type: object
          nullable: true
          additionalProperties: true
          description: Additional inputs to provide for the resumed execution
        resolvedNodes:
          type: object
          nullable: true
          additionalProperties: true
          description: Resolved node values to inject into the execution

    ComponentMetadata:
      type: object
      required:
        - name
        - description
        - tags
        - majorVersion
        - minorVersion
      properties:
        name:
          type: string
          description: Component name
        description:
          type: string
          description: Human-readable description
        tags:
          type: array
          items:
            type: string
          description: Classification tags
        majorVersion:
          type: integer
          description: Major version number
        minorVersion:
          type: integer
          description: Minor version number

    ModuleListResponse:
      type: object
      required:
        - modules
      properties:
        modules:
          type: array
          items:
            $ref: '#/components/schemas/ModuleInfo'

    ModuleInfo:
      type: object
      required:
        - name
        - description
        - version
        - inputs
        - outputs
      properties:
        name:
          type: string
          description: Module name (use in constellation-lang scripts)
        description:
          type: string
          description: Module description
        version:
          type: string
          description: Version string (major.minor)
        inputs:
          type: object
          additionalProperties:
            type: string
          description: Input parameter names and types
        outputs:
          type: object
          additionalProperties:
            type: string
          description: Output names and types

    NamespaceListResponse:
      type: object
      required:
        - namespaces
      properties:
        namespaces:
          type: array
          items:
            type: string
          description: List of available namespace names

    NamespaceFunctionsResponse:
      type: object
      required:
        - namespace
        - functions
      properties:
        namespace:
          type: string
          description: Namespace name
        functions:
          type: array
          items:
            $ref: '#/components/schemas/FunctionInfo'

    FunctionInfo:
      type: object
      required:
        - name
        - qualifiedName
        - params
        - returns
      properties:
        name:
          type: string
          description: Function name
        qualifiedName:
          type: string
          description: Fully qualified name including namespace
        params:
          type: array
          items:
            type: string
          description: Parameter signatures (e.g., "name: Type")
        returns:
          type: string
          description: Return type

    HealthLiveResponse:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          enum: [alive]
          description: Always "alive" when the process is running

    HealthReadyResponse:
      type: object
      required:
        - ready
      properties:
        ready:
          type: boolean
          description: Whether the system is ready to serve traffic
        reason:
          type: string
          description: Reason for not being ready (only present when ready=false)

    HealthDetailResponse:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          description: Overall health status
          enum: [healthy, degraded, unhealthy]
        lifecycle:
          type: string
          description: Current lifecycle state
          enum: [Running, Draining, Stopped]
        scheduler:
          type: object
          description: Scheduler statistics (present when scheduler is configured)
          properties:
            activeCount:
              type: integer
              description: Currently running tasks
            queuedCount:
              type: integer
              description: Tasks waiting in queue
            totalSubmitted:
              type: integer
              format: int64
              description: Lifetime task submissions
            totalCompleted:
              type: integer
              format: int64
              description: Lifetime task completions
        checks:
          type: object
          additionalProperties:
            type: boolean
          description: Results of custom readiness checks

    MetricsResponse:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
          description: ISO-8601 timestamp
        server:
          type: object
          properties:
            uptime_seconds:
              type: integer
              format: int64
              description: Server uptime in seconds
            requests_total:
              type: integer
              format: int64
              description: Total HTTP requests served
        cache:
          type: object
          description: Compilation cache statistics (present when caching compiler is used)
          properties:
            hits:
              type: integer
              format: int64
            misses:
              type: integer
              format: int64
            hitRate:
              type: number
              format: double
            evictions:
              type: integer
              format: int64
            entries:
              type: integer
        scheduler:
          type: object
          description: Scheduler statistics
          properties:
            enabled:
              type: boolean
            activeCount:
              type: integer
            queuedCount:
              type: integer
            totalSubmitted:
              type: integer
              format: int64
            totalCompleted:
              type: integer
              format: int64
            highPriorityCompleted:
              type: integer
              format: int64
            lowPriorityCompleted:
              type: integer
              format: int64
            starvationPromotions:
              type: integer
              format: int64

    ErrorResponse:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Error code
          example: "NotFound"
        message:
          type: string
          description: Human-readable error message
          example: "Pipeline 'unknown-pipeline' not found"
        requestId:
          type: string
          description: Request ID for tracing (from X-Request-ID header or auto-generated)
          example: "550e8400-e29b-41d4-a716-446655440000"
