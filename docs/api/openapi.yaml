openapi: 3.0.3
info:
  title: Constellation Engine API
  version: 0.2.0
  description: |
    REST API for the Constellation Engine - a type-safe, composable ML orchestration framework.

    This API allows you to:
    - Compile constellation-lang source code into executable programs
    - Execute compiled programs with input data
    - Compile and run scripts in a single request
    - Query available modules and namespaces

    ## Quick Start

    1. Compile a script: `POST /compile`
    2. Execute it: `POST /execute`

    Or use the combined endpoint: `POST /run`

    ## WebSocket

    For IDE integration via Language Server Protocol (LSP), connect to `ws://host:port/lsp`.
    See the LSP documentation for message formats.
  contact:
    name: Constellation Engine
    url: https://github.com/VledicFranco/constellation-engine
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8080
    description: Local development server

tags:
  - name: Compilation
    description: Compile constellation-lang source code
  - name: Execution
    description: Execute compiled DAGs
  - name: Programs
    description: Manage stored programs (content-addressed)
  - name: Modules
    description: Query available modules
  - name: Namespaces
    description: Query function namespaces
  - name: Health
    description: Server health and readiness checks
  - name: Metrics
    description: Server metrics and statistics

paths:
  /compile:
    post:
      tags:
        - Compilation
      summary: Compile constellation-lang source code
      description: |
        Compiles constellation-lang source code and stores the resulting DAG
        with the specified name. The DAG can then be executed via `/execute`.
      operationId: compile
      security:
        - bearerAuth: []
        - {}
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CompileRequest'
            example:
              source: |
                in text: String
                result = Uppercase(text)
                out result
              dagName: "my-pipeline"
      responses:
        '200':
          description: Compilation successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CompileResponse'
              example:
                success: true
                dagName: "my-pipeline"
                errors: []
        '400':
          description: Compilation errors
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CompileResponse'
              example:
                success: false
                dagName: null
                errors:
                  - "Undefined function: Upppercase"
                  - "Type mismatch: expected String, got Int"
        '413':
          description: Request body too large (max 10MB)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: Rate limit exceeded
          headers:
            Retry-After:
              schema:
                type: integer
              description: Seconds to wait before retrying
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /execute:
    post:
      tags:
        - Execution
      summary: Execute a stored DAG
      description: |
        Executes a previously compiled DAG with the provided inputs.
        The DAG must have been stored via `/compile` first.
      operationId: execute
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExecuteRequest'
            example:
              dagName: "my-pipeline"
              inputs:
                text: "hello world"
      responses:
        '200':
          description: Execution successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExecuteResponse'
              example:
                success: true
                outputs:
                  result: "HELLO WORLD"
                error: null
        '400':
          description: Input validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExecuteResponse'
              example:
                success: false
                outputs: {}
                error: "Input error: Missing required input 'text'"
        '404':
          description: DAG not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "DagNotFound"
                message: "DAG 'unknown-pipeline' not found"
        '500':
          description: Execution error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExecuteResponse'
              example:
                success: false
                outputs: {}
                error: "Execution failed: Module 'ExternalAPI' threw exception"

  /run:
    post:
      tags:
        - Compilation
        - Execution
      summary: Compile and run a script in one step
      description: |
        Compiles constellation-lang source code and executes it immediately
        without storing the DAG. Useful for one-off executions and testing.
      operationId: run
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RunRequest'
            example:
              source: |
                in name: String
                in count: Int
                greeting = Concat("Hello, ", name)
                repeated = Repeat(greeting, count)
                out repeated
              inputs:
                name: "World"
                count: 3
      responses:
        '200':
          description: Compilation and execution successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunResponse'
              example:
                success: true
                outputs:
                  repeated: "Hello, World Hello, World Hello, World"
                compilationErrors: []
                error: null
        '400':
          description: Compilation or input error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunResponse'
              example:
                success: false
                outputs: {}
                compilationErrors:
                  - "Undefined function: Repeatt"
                error: null
        '500':
          description: Execution error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunResponse'
              example:
                success: false
                outputs: {}
                compilationErrors: []
                error: "Execution failed: Division by zero"

  /modules:
    get:
      tags:
        - Modules
      summary: List all available modules
      description: |
        Returns a list of all registered modules that can be used in
        constellation-lang scripts. Includes module signatures and descriptions.
      operationId: listModules
      responses:
        '200':
          description: List of modules
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModuleListResponse'
              example:
                modules:
                  - name: "Uppercase"
                    description: "Converts text to uppercase"
                    version: "1.0"
                    inputs:
                      text: "CString"
                    outputs:
                      result: "CString"
                  - name: "WordCount"
                    description: "Counts words in text"
                    version: "1.0"
                    inputs:
                      text: "CString"
                    outputs:
                      count: "CInt"

  /namespaces:
    get:
      tags:
        - Namespaces
      summary: List all available namespaces
      description: |
        Returns a list of all function namespaces available for import
        in constellation-lang scripts using `use` statements.
      operationId: listNamespaces
      responses:
        '200':
          description: List of namespaces
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NamespaceListResponse'
              example:
                namespaces:
                  - "stdlib"
                  - "stdlib.math"
                  - "stdlib.string"
                  - "stdlib.boolean"

  /namespaces/{namespace}:
    get:
      tags:
        - Namespaces
      summary: List functions in a namespace
      description: |
        Returns all functions available in a specific namespace.
        Includes function signatures and parameter types.
      operationId: getNamespaceFunctions
      parameters:
        - name: namespace
          in: path
          required: true
          description: Namespace name
          schema:
            type: string
          example: "stdlib.math"
      responses:
        '200':
          description: Namespace functions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NamespaceFunctionsResponse'
              example:
                namespace: "stdlib.math"
                functions:
                  - name: "Add"
                    qualifiedName: "stdlib.math.Add"
                    params:
                      - "a: Int"
                      - "b: Int"
                    returns: "Int"
                  - name: "Multiply"
                    qualifiedName: "stdlib.math.Multiply"
                    params:
                      - "a: Int"
                      - "b: Int"
                    returns: "Int"
        '404':
          description: Namespace not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "NamespaceNotFound"
                message: "Namespace 'stdlib.unknown' not found or has no functions"

  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Returns server health status. Basic health endpoint for simple checks.
      operationId: healthCheck
      responses:
        '200':
          description: Server is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [ok]
              example:
                status: "ok"

  /health/live:
    get:
      tags:
        - Health
      summary: Liveness probe
      description: |
        Returns 200 if the process is alive. Always succeeds when the server is running.
        Use for Kubernetes liveness probes.
      operationId: healthLive
      responses:
        '200':
          description: Process is alive
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthLiveResponse'
              example:
                status: "alive"

  /health/ready:
    get:
      tags:
        - Health
      summary: Readiness probe
      description: |
        Returns 200 if the system is ready to serve traffic, 503 otherwise.
        Checks lifecycle state (must be Running) and any custom readiness checks.
        Use for Kubernetes readiness probes.
      operationId: healthReady
      responses:
        '200':
          description: System is ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthReadyResponse'
              example:
                ready: true
        '503':
          description: System is not ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthReadyResponse'
              example:
                ready: false
                reason: "System is draining"

  /health/detail:
    get:
      tags:
        - Health
      summary: Detailed health diagnostics
      description: |
        Returns component-level diagnostics including scheduler stats, lifecycle state,
        and custom check results. This endpoint is **opt-in** â€” it must be explicitly
        enabled via `HealthCheckConfig(enableDetailEndpoint = true)`.

        When `detailRequiresAuth` is true (default), this endpoint requires
        authentication via Bearer token.
      operationId: healthDetail
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Detailed health information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthDetailResponse'
              example:
                status: "healthy"
                lifecycle: "Running"
                scheduler:
                  activeCount: 3
                  queuedCount: 0
                  totalSubmitted: 1500
                  totalCompleted: 1497
                checks:
                  compiler: true
                  scheduler: true
        '401':
          description: Missing or invalid authentication
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Unauthorized"
                message: "Missing or invalid Authorization header"
        '403':
          description: Insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Forbidden"
                message: "Insufficient permissions"
        '404':
          description: Detail endpoint not enabled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "NotFound"
                message: "Detail endpoint is not enabled"

  /programs:
    get:
      tags:
        - Programs
      summary: List all stored programs
      description: |
        Returns all programs stored in the ProgramStore, including their
        structural hash, syntactic hash, name, and metadata.
      operationId: listPrograms
      responses:
        '200':
          description: List of stored programs
          content:
            application/json:
              schema:
                type: object
                properties:
                  programs:
                    type: array
                    items:
                      type: object
                      properties:
                        name:
                          type: string
                        structuralHash:
                          type: string
                        syntacticHash:
                          type: string

  /programs/{ref}:
    get:
      tags:
        - Programs
      summary: Get a program by reference
      description: |
        Retrieve a stored program by name, structural hash, or syntactic hash.
        Returns program details including modules, inputs, and outputs.
      operationId: getProgram
      parameters:
        - name: ref
          in: path
          required: true
          description: Program reference (name, structural hash, or syntactic hash)
          schema:
            type: string
      responses:
        '200':
          description: Program found
          content:
            application/json:
              schema:
                type: object
        '404':
          description: Program not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      tags:
        - Programs
      summary: Delete a program
      description: Remove a stored program by reference.
      operationId: deleteProgram
      security:
        - bearerAuth: []
      parameters:
        - name: ref
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Program deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  deleted:
                    type: boolean
                  ref:
                    type: string
        '404':
          description: Program not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /programs/{name}/alias:
    put:
      tags:
        - Programs
      summary: Repoint a program alias
      description: |
        Update a named program alias to point to a different structural hash.
        Allows blue-green deployments by atomically switching which version a name resolves to.
      operationId: updateProgramAlias
      security:
        - bearerAuth: []
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - structuralHash
              properties:
                structuralHash:
                  type: string
                  description: Target structural hash to alias to
      responses:
        '200':
          description: Alias updated
        '404':
          description: Target hash not found

  /metrics:
    get:
      tags:
        - Metrics
      summary: Server metrics
      description: |
        Returns server statistics including uptime, request count,
        compilation cache metrics, and scheduler statistics.
      operationId: getMetrics
      responses:
        '200':
          description: Current server metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MetricsResponse'
              example:
                timestamp: "2026-01-15T10:30:00Z"
                server:
                  uptime_seconds: 3600
                  requests_total: 15000
                cache:
                  hits: 12000
                  misses: 3000
                  hitRate: 0.8
                  evictions: 50
                  entries: 200
                scheduler:
                  enabled: true
                  activeCount: 3
                  queuedCount: 0
                  totalSubmitted: 15000
                  totalCompleted: 14997

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      description: |
        API key authentication. Pass the API key as a Bearer token in the
        Authorization header: `Authorization: Bearer <api-key>`.

        Roles: Admin (all methods), Execute (GET + POST), ReadOnly (GET only).

        Public paths exempt from auth: `/health`, `/health/live`, `/health/ready`, `/metrics`.

  schemas:
    CompileRequest:
      type: object
      required:
        - source
        - dagName
      properties:
        source:
          type: string
          description: Constellation-lang source code
          example: |
            in text: String
            result = Uppercase(text)
            out result
        dagName:
          type: string
          description: Name to assign to the compiled DAG
          example: "my-pipeline"

    CompileResponse:
      type: object
      required:
        - success
      properties:
        success:
          type: boolean
          description: Whether compilation succeeded
        dagName:
          type: string
          nullable: true
          description: Name of the compiled DAG (if successful)
        errors:
          type: array
          items:
            type: string
          description: List of compilation error messages
          default: []

    ExecuteRequest:
      type: object
      required:
        - dagName
        - inputs
      properties:
        dagName:
          type: string
          description: Name of the DAG to execute
        inputs:
          type: object
          additionalProperties: true
          description: Input values as JSON (keys must match DAG input declarations)

    ExecuteResponse:
      type: object
      required:
        - success
      properties:
        success:
          type: boolean
          description: Whether execution succeeded
        outputs:
          type: object
          additionalProperties: true
          description: Output values as JSON
          default: {}
        error:
          type: string
          nullable: true
          description: Error message if execution failed

    RunRequest:
      type: object
      required:
        - source
        - inputs
      properties:
        source:
          type: string
          description: Constellation-lang source code
        inputs:
          type: object
          additionalProperties: true
          description: Input values as JSON

    RunResponse:
      type: object
      required:
        - success
      properties:
        success:
          type: boolean
          description: Whether compilation and execution succeeded
        outputs:
          type: object
          additionalProperties: true
          description: Output values as JSON
          default: {}
        compilationErrors:
          type: array
          items:
            type: string
          description: List of compilation error messages
          default: []
        error:
          type: string
          nullable: true
          description: Runtime error message if execution failed

    ComponentMetadata:
      type: object
      required:
        - name
        - description
        - tags
        - majorVersion
        - minorVersion
      properties:
        name:
          type: string
          description: Component name
        description:
          type: string
          description: Human-readable description
        tags:
          type: array
          items:
            type: string
          description: Classification tags
        majorVersion:
          type: integer
          description: Major version number
        minorVersion:
          type: integer
          description: Minor version number

    ModuleListResponse:
      type: object
      required:
        - modules
      properties:
        modules:
          type: array
          items:
            $ref: '#/components/schemas/ModuleInfo'

    ModuleInfo:
      type: object
      required:
        - name
        - description
        - version
        - inputs
        - outputs
      properties:
        name:
          type: string
          description: Module name (use in constellation-lang scripts)
        description:
          type: string
          description: Module description
        version:
          type: string
          description: Version string (major.minor)
        inputs:
          type: object
          additionalProperties:
            type: string
          description: Input parameter names and types
        outputs:
          type: object
          additionalProperties:
            type: string
          description: Output names and types

    NamespaceListResponse:
      type: object
      required:
        - namespaces
      properties:
        namespaces:
          type: array
          items:
            type: string
          description: List of available namespace names

    NamespaceFunctionsResponse:
      type: object
      required:
        - namespace
        - functions
      properties:
        namespace:
          type: string
          description: Namespace name
        functions:
          type: array
          items:
            $ref: '#/components/schemas/FunctionInfo'

    FunctionInfo:
      type: object
      required:
        - name
        - qualifiedName
        - params
        - returns
      properties:
        name:
          type: string
          description: Function name
        qualifiedName:
          type: string
          description: Fully qualified name including namespace
        params:
          type: array
          items:
            type: string
          description: Parameter signatures (e.g., "name: Type")
        returns:
          type: string
          description: Return type

    HealthLiveResponse:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          enum: [alive]
          description: Always "alive" when the process is running

    HealthReadyResponse:
      type: object
      required:
        - ready
      properties:
        ready:
          type: boolean
          description: Whether the system is ready to serve traffic
        reason:
          type: string
          description: Reason for not being ready (only present when ready=false)

    HealthDetailResponse:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          description: Overall health status
          enum: [healthy, degraded, unhealthy]
        lifecycle:
          type: string
          description: Current lifecycle state
          enum: [Running, Draining, Stopped]
        scheduler:
          type: object
          description: Scheduler statistics (present when scheduler is configured)
          properties:
            activeCount:
              type: integer
              description: Currently running tasks
            queuedCount:
              type: integer
              description: Tasks waiting in queue
            totalSubmitted:
              type: integer
              format: int64
              description: Lifetime task submissions
            totalCompleted:
              type: integer
              format: int64
              description: Lifetime task completions
        checks:
          type: object
          additionalProperties:
            type: boolean
          description: Results of custom readiness checks

    MetricsResponse:
      type: object
      properties:
        timestamp:
          type: string
          format: date-time
          description: ISO-8601 timestamp
        server:
          type: object
          properties:
            uptime_seconds:
              type: integer
              format: int64
              description: Server uptime in seconds
            requests_total:
              type: integer
              format: int64
              description: Total HTTP requests served
        cache:
          type: object
          description: Compilation cache statistics (present when caching compiler is used)
          properties:
            hits:
              type: integer
              format: int64
            misses:
              type: integer
              format: int64
            hitRate:
              type: number
              format: double
            evictions:
              type: integer
              format: int64
            entries:
              type: integer
        scheduler:
          type: object
          description: Scheduler statistics
          properties:
            enabled:
              type: boolean
            activeCount:
              type: integer
            queuedCount:
              type: integer
            totalSubmitted:
              type: integer
              format: int64
            totalCompleted:
              type: integer
              format: int64
            highPriorityCompleted:
              type: integer
              format: int64
            lowPriorityCompleted:
              type: integer
              format: int64
            starvationPromotions:
              type: integer
              format: int64

    ErrorResponse:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Error code
          example: "DagNotFound"
        message:
          type: string
          description: Human-readable error message
          example: "DAG 'unknown-pipeline' not found"
        requestId:
          type: string
          description: Request ID for tracing (from X-Request-ID header or auto-generated)
          example: "550e8400-e29b-41d4-a716-446655440000"
