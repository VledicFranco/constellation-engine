# =============================================================================
# Constellation Engine - Docker Compose Dev Stack
# =============================================================================
# Usage:
#   docker compose up              # Start server
#   docker compose up --build      # Rebuild and start
#   docker compose down            # Stop
#
# Override environment variables in a .env file or inline:
#   CONSTELLATION_PORT=9090 docker compose up
# =============================================================================

services:
  constellation:
    build: .
    ports:
      - "${CONSTELLATION_PORT:-8080}:${CONSTELLATION_PORT:-8080}"
    environment:
      CONSTELLATION_PORT: "${CONSTELLATION_PORT:-8080}"
      CONSTELLATION_SCHEDULER_ENABLED: "${CONSTELLATION_SCHEDULER_ENABLED:-true}"
      CONSTELLATION_SCHEDULER_MAX_CONCURRENCY: "${CONSTELLATION_SCHEDULER_MAX_CONCURRENCY:-16}"
      CONSTELLATION_SCHEDULER_STARVATION_TIMEOUT: "${CONSTELLATION_SCHEDULER_STARVATION_TIMEOUT:-30s}"
      JAVA_OPTS: "${JAVA_OPTS:--Xms256m -Xmx1g}"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${CONSTELLATION_PORT:-8080}/health/live"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

  # ---------------------------------------------------------------------------
  # Monitoring (uncomment when /metrics endpoint is available)
  # ---------------------------------------------------------------------------
  # prometheus:
  #   image: prom/prometheus:latest
  #   ports:
  #     - "9090:9090"
  #   volumes:
  #     - ./deploy/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
  #   depends_on:
  #     constellation:
  #       condition: service_healthy
  #
  # grafana:
  #   image: grafana/grafana:latest
  #   ports:
  #     - "3000:3000"
  #   environment:
  #     GF_SECURITY_ADMIN_PASSWORD: admin
  #   depends_on:
  #     - prometheus
